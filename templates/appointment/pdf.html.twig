<html lang="fr">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Votre facture</title>
		<style>
			body {
				font-family: AirbnbCereal, sans-serif;
				font-size: 12px;
				margin: 0;
			}
			.text-center {
				text-align: center;
			}
			.text-right {
				text-align: right;
			}
			.text-left {
				text-align: left;
			}
			table {
				border-collapse: collapse;
				width: 100%;
			}
			th,
			td {
				padding: 0.5rem;
				border-top: 1px solid #ccc;
				vertical-align: top;
			}
			.mt-1 {
				margin-top: 0.5rem;
			}
			.mt-2 {
				margin-top: 1rem;
			}
			.mt-3 {
				margin-top: 1.5rem;
			}
			.mb-2 {
				margin-bottom: 1rem;
			}

			/* Marges page PDF */
			@page {
				margin: 20mm 15mm 30mm;
			} /* bas plus grand pour caser le footer */
			.page-wrap {
				padding: 0 0 60px;
			} /* éviter chevauchement footer */

			/* Footer fixé */
			.pdf-footer {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				font-size: 10px;
				color: #555;
				border-top: 1px solid #ccc;
				padding: 6px 10mm 4px;
			}
			.pdf-footer .footer-grid {
				display: table;
				width: 100%;
			}
			.pdf-footer .col {
				display: table-cell;
				vertical-align: top;
				width: 33%;
			}
			.pdf-footer .col.right {
				text-align: right;
			}
			.pdf-footer .label {
				color: #888;
			}

			h3 {
				margin: 0 0 0.5rem;
			}
		</style>
	</head>
	<body>
		<div class="page-wrap">
			<div class="text-center mb-2">
				<h3>Facture RDV n°{{ appointment.number }}</h3>
			</div>
			{# En-tête avec société (fallback si company est null) #}
			<table style="border-bottom:1px solid #999;">
				<tr>
					<td style="width: 60%;">
						{% set co = company ?? null %}
						<strong>{{ co ? co.name : 'Nom de l\'entreprise' }}</strong><br/>
                        {{ co ? co.adress : '' }}<br/>
                        {{ co ? co.postalCode ~ ' ' ~ co.city : '' }}<br/>
                        {{ co ? co.email : '' }}<br/>
                        {{ co and co.phone ? co.phone|phone_number_format('NATIONAL', 'FR') : '' }}
                    </td>
                    <td class="text-right" style="width: 40%;">
                    {# Client #}
                    {% set u = appointment.user %}
                    <strong>{{ u.firstname }} {{ u.lastname }}</strong><br/>
                    {{ u.adress }}<br/>
                    {{ u.postalCode }} {{ u.city }}<br/>
                    {{ u.email }}
                    </td>
                </tr>
            </table>
            {# Titre / référence #}
            <h3 class="mt-2">
            RDV n°
            {{ appointment.number is defined and appointment.number ? appointment.number : appointment.id }}
            </h3>
            {# Bloc RDV #}
            <table class="mt-1">
            <tbody>
                <tr>
                <th class="text-left" style="width: 30%;">Type de rendez-vous</th>
                <td class="text-left">{{ appointment.type.name ?? '—' }}</td>
                </tr>
                <tr>
                <th class="text-left">Débute le</th>
                <td class="text-left">{{ appointment.startAt|format_datetime('long','short', timezone=tz, locale='fr') }}</td>
                </tr>
                <tr>
                <th class="text-left">Se termine le</th>
                <td class="text-left">{{ appointment.endAt|format_datetime('long','short', timezone=tz, locale='fr') }}</td>
                </tr>

                {% if appointment.evaluatedPerson is defined and appointment.evaluatedPerson %}
                <tr>
                    <th class="text-left">Personne évaluée</th>
                    <td class="text-left">
                    {{ appointment.evaluatedPerson.firstName ?? '' }} {{ appointment.evaluatedPerson.lastName ?? '' }}
                    {% if appointment.evaluatedPerson.birthdate is defined and appointment.evaluatedPerson.birthdate %}
                        — né(e) le {{ appointment.evaluatedPerson.birthdate|date('d/m/Y') }}
                    {% endif %}
                    </td>
                </tr>
                {% endif %}

                {% set total = appointment.type.price %}
                {% if total is not null %}
                <tr>
                    <th class="text-left">Montant payé T.T.C</th>
                    <td class="text-left">{{ total|amount }}</td>
                </tr>
                {% endif %}

                <tr>
                <th class="text-left">Statut</th>
                <td class="text-left">
                    {% if appointment.status == constant('App\\Enum\\AppointmentStatus::CONFIRMED') %}
                    Payé
                    {% else %}
                    {{ appointment.status }}
                    {% endif %}
                </td>
                </tr>
            </tbody>
            </table>
            <p class="mt-3">
            Document généré le {{ "now"|format_datetime('long', 'short', timezone=tz, locale='fr') }}.
            </p>
        </div>
        {# ====== FOOTER MENTIONS LÉGALES ====== #}
        <div class="pdf-footer">
            <div class="footer-grid">
            <div class="col">
                <div><span class="label">Siège social</span><br>
                {{ co ? co.adress ~ ', ' ~ co.postalCode ~ ' ' ~ co.city : '—' }}
                </div>
            </div>
            <div class="col">
                <div><span class="label">Nom entreprise</span><br>
                {{ co ? co.name : '—' }}
                </div>
            </div>
            <div class="col right">
                <div>
                <div><span class="label">SIREN</span> : {{ co and co.siren ? co.siren : '—' }}</div>
                <div>TVA non applicable, art. 293 B du CGI</div>
                </div>
            </div>
            </div>
        </div>
    </body>
</html>
